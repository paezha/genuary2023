---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Asemic

<!-- badges: start -->
<!-- badges: end -->

The basis for this is the code of Georgios Karamanis to create asemic glyphs: check https://github.com/gkaramanis/aRtist/blob/main/asemic/asemic.R

## Create a set of glyphs

Set the parameters for creating the glyphs, that is, the number of glyphs (corresponding to letters), the number of points to generate each glyph (used by the splines function), and the cutoff for the thickness of the lines; notice that special characters are added to the set of letters:
```{r setup}
library(dplyr) # A Grammar of Data Manipulation
library(ggforce) # Accelerating 'ggplot2'
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
library(glue) # Interpreted String Literals
library(stringr) # Simple, Consistent Wrappers for Common String Operations
library(tidyr) # Tidy Messy Data
```

## Generate a random seed

```{r}
seed <- sample.int(100000000, 1)
# seed <- 83744970
```

## Create a set of glyphs

Set the parameters for creating the glyphs, that is, the number of glyphs (corresponding to letters), the number of points to generate each glyph (used by the splines function), and the cutoff for the thickness of the lines; notice that special characters are added to the set of letters:
```{r}
#set.seed(seed)

l <- c(letters, "'", "-", ":", "?", "(", ")") 
nl <- length(l) # Number of letters
```

Create strokes:
```{r}

strokes <- c("stroke1", "stroke2", "stroke3", "stroke4", "stroke5", "stroke6", "stroke7", "stroke8", "stroke9")
n_strokes <- length(strokes)

strokes <- data.frame(stroke = factor(rep(strokes, each = 4)))

#n_strokes <- nlevels(strokes$stroke)

strokes$rx <- c(0.15, 0.15, 0.65, 0.65,
                0.1, 0.125, 0.15, 0.175,
                0.1, 0.125, 0.15, 0.175,
                0.7, 0.725, 0.75, 0.775,
                0.1, 0.4, 0.9, 0.7,
                0.0, 1.0, 0.5, 0.0,
                0.175, 1.2, 0.225, 0.25,
                0.45, 0.475, 0.5, 0.53,
                0.8, 0.773, 0.75, 0.72)

# Did not quite like what happens when I randomize the coordinates
# strokes$rx <- c(runif(4, 0.15, 0.65) |> sort(),
#                 runif(4, 0.1, 0.175) |> sort(),
#                 runif(4, 0.1, 0.175) |> sort(),
#                 runif(4, 0.7, 0.8),
#                 runif(4, 0.1, 0.7),
#                 runif(4, 0.0, 1))

strokes$ry <- c(0.30, 0.70, 0.70, 0.20,
                0.75, 0.725, 0.7, 0.675,
                0.25, 0.3, 0.35, 0.4,
                0.8, 0.6, 0.4, 0.2,
                0.8, 0.9, 0.9, 0.8,
                0.5, 1.0, 0, 0.5,
                0.8, 0.75, 0.7, 0.65,
                0.85, 0.825, 0.8, 0.775,
                0.8, 0.75, 0.7, 0.65)

# strokes$ry <- c(runif(4, 0.3, 0.7),
#                 runif(4, 0.675, 0.75),
#                 runif(4, 0.25, 0.4),
#                 runif(4, 0.2, 0.8),
#                 runif(4, 0.8, 0.9),
#                 runif(4, 0.0, 1))

strokes$size <- rep(c(0.1, 0.3, 0.5, 0.7), n_strokes)
```

Plot individual strokes:
```{r}
strokes |> 
  mutate(x = as.numeric(stroke),
         rx = rx + x) |>
  ggplot() +
  geom_bspline2(aes(x = rx, 
                    y = ry, 
                    #color = type, 
                    group = stroke,
                    linewidth = size),
                n = 800, 
                lineend = "round") + 
  scale_linewidth(range = c(0.2,2)) +
  ylim(c(0, 1)) +
  coord_equal()

```

Select number of glyphs and randomly choose number of strokes and strokes for the glyphs:
```{r}
set.seed(seed)

n_glyphs <- nl

glyphs <-  data.frame(glyph = 1:n_glyphs) |>
  # Randomly choose number of strokes for each glyph
  mutate(n_strokes = sample.int(2, n(), replace = TRUE) + sample.int(2, n(), replace = TRUE)) |>
  # Uncount to have as many rows per glyph as number of strokes
  uncount(n_strokes) |>
  # Sample the strokes for the glyph
  mutate(stroke = sample(unique(strokes$stroke), n(), replace = TRUE)) |>
  # Create an identifier for the glyph-stroke pair
  mutate(gs = factor(1:n())) |>
  # Group by glyph
  group_by(glyph) |>
  # Create identifier for position of stroke in glyph
  mutate(s = 1:n()) |>
  # Ungroup data frame
  ungroup() |>
  distinct(gs, .keep_all = TRUE)  
```

Join strokes to glyphs:
```{r}
glyphs <- glyphs |>
  left_join(strokes,
            by = "stroke")
```

Generate a test "text" by choosing number of rows and number of columns:
```{r}
set.seed(seed)

n_row <- 8
n_col <- 6

text <- expand.grid(x = seq(0, n_row, 1), y = seq(n_col, 0, -1)) |>
  # Generate id for the position of glyphs in the text
  mutate(id = 1:n(),
         # Sample glyph identifiers
         glyph = sample.int(n_glyphs, 
                            n(), 
                            replace = TRUE)) |>
  # Join strokes coresponding to each glyph identifier
  left_join(glyphs,
            by = "glyph") |> 
  # Randomize the strokes position and size by a small amount
  mutate(rx = x + rx + runif(n(), 0.95, 1.05) + s * runif(n(), 0.01, 0.10),
         ry = y + ry + runif(n(), 0.95, 1.05),
         size = 3 * size * runif(n(), 0.95,1.05))
```

Plot test text:
```{r}
text  |>
  ggplot() +
  geom_bspline2(aes(x = rx, 
                    y = ry, 
                    #color = type, 
                    group = x, #try x and id
                    linewidth = size),
                n = 800, 
                lineend = "round") + 
  # geom_text(aes(x =  x + 1.5, 
  #               y = y + 1, 
  #               label = glyph),
  #           color = "red") +
  scale_linewidth(range = c(0.0, 2.5)) +
  coord_equal() +
  #coord_equal(xlim = c(-1, 30), ylim = c(0, 2))# +
  theme_void() +
  theme(legend.position = "none")
```

## Use poem

Data frame with text (poem by Lady [Ono no Komachi](https://allpoetry.com/Visible-colours)):
```{r}
tanka <- data.frame(text = c("Visible colours", "-Invisible passions-", "Fade from", "This world's", "Human hearts", "And flowers.")) |>
  # Convert all to lower case
  mutate(text = str_to_lower(text))
```

Prepare text:
```{r}
#find the maximum width of a line in number of characters
pad <- max(str_length(tanka$text))

# Pad the strings to have the same width
tanka <- tanka |>
  mutate(text = str_pad(text, width = pad, side = "right"))

cols <- nrow(tanka)
```

## Join text to glyphs

Convert text to single characters and add the coordinates to place the glyphs in the block of text:
```{r}
set.seed(seed)

atext <- data.frame(x = rep(seq(2 * cols, 2 * 1, -2), each = pad),
                    y = rep(pad:1, cols),
                    letter = str_split(tanka$text, pattern = "") |> 
                      unlist(),
                    type = "text") |>
  mutate(id = 1:n()) |>
  left_join(data.frame(letter = l, glyph = 1:nl),
            by = "letter") |>
  # Join strokes coresponding to each glyph identifier
  left_join(glyphs,
            by = "glyph") |> 
  # Randomize the strokes position and size by a small amount
  mutate(rx = x + rx + runif(n(), 0.95, 1.05) + s * runif(n(), 0.01, 0.10),
         ry = y + ry + runif(n(), 0.95, 1.05),
         size = 3 * size * runif(n(), 0.95,1.05)) |>
  drop_na()


```

Parameters for saving image:
```{r}
x_range <- max(atext$x) - min(atext$x)
y_range <- max(atext$y) - min(atext$y)

if(x_range > y_range){
  w = 7
  h = 7 * y_range/x_range
}else{
  w = 7 * x_range/y_range
  h = 7
}
```


Plot:
```{r}
atext |>
  #slice_head(n = 73) |>
  ggplot() +
  geom_bspline2(aes(x = rx, 
                    y = ry, 
                    #color = type, 
                    group = x, #try x and id
                    linewidth = size),
                n = 800, 
                lineend = "round") + 
  scale_linewidth(range = c(0.0, 1.5)) +
  coord_equal() +
  theme_void() +
  theme(legend.position = "none",
        panel.background = element_rect(color = NA,
                                        fill = "white"))

# Save named image
ggsave(glue::glue("outputs/asemic-poetry-{seed}.png"),
height = h,
width = w,
units = "in")
```


```{r echo=FALSE, out.width="500px"}
# Display image
knitr::include_graphics(glue::glue("outputs/asemic-poetry-{seed}.png"))
```


<!--

Plot:
```{r fig.show='hide'}
ggplot() +
# Use the coordinates to create splines: these are the glyphs
geom_bspline2(data = atext_lr,
aes(x = rx,
y = ry,
color = type,
group = y,
linewidth = size),
n = 800,
lineend = "round") +
geom_bspline2(data = accents, 
aes(x = rx, 
y = ry, 
color = type, 
group = id,
linewidth = size * 3),
n = 800, 
lineend = "round") +
scale_linewidth_continuous(range = c(0, 1.5)) +
# Define colors for each typeglyphs
scale_color_manual(values = c("text" = "black", "signature" = "red")) +
theme_void() +
#coord_equal() +
theme(#aspect.ratio = 4,
legend.position = "none",
plot.background = element_rect(fill = "grey97", color = NA)
)

# Save named image
ggsave(glue::glue("outputs/asemic-haiku-lr-{seed}.png"),
height = 4,
width = 7,
units = "in")
```

```{r echo=FALSE, out.width="500px"}
# Display image
knitr::include_graphics(glue("outputs/asemic-haiku-lr-{seed}.png"))
```

## Right-left, bottom-down writing:

Convert text to vector add coordinates for placement in block of text:
```{r}
atext <- data.frame(x = rep(3:1, each = pad),
y = rep(pad:1, 3),
letter = str_split(haiku$text, pattern = "") |> 
unlist(),
type = "text")
```

Create signature:
```{r}
signature <- data.frame(x = rep(max(atext$x) + 1, 2),
y = c(0, 0),
letter = c("a", "p"),
type = "signature") 
```

```{r}
accents <- slice_sample(atext, prop =0.8, replace = TRUE) |>
mutate(id = 1:n(),
letter = sample(special_chars$accent, n(), replace = TRUE))
```

Bind signature to data frame with text:
```{r}
atext <- rbind(atext,
signature)
```

Join asemic characters to text and accents:
```{r}
atext_bd <- atext %>%
left_join(flo2,
by = "letter")

accents <- accents |>
left_join(special_chars,
by = c("letter" = "accent"))

atext_bd <- atext_bd |>
# Adjust the values of the points rx and ry by their position in the block of text (row and column)
mutate(rx = rx + x, 
ry = ry + y,
# Delete white spaces
rx = ifelse(letter == " ", NA, rx),
ry = ifelse(letter == " ", NA, ry))

accents <- accents |>
# Adjust the values of the points rx and ry by their position in the block of text (row and column)
mutate(rx = rx + x, 
ry = ry + y,
# Delete white spaces
rx = ifelse(letter == " ", NA, rx),
ry = ifelse(letter == " ", NA, ry),
type = "text")
```

Plot:
```{r fig.show='hide'}
ggplot() +
# Use the coordinates to create splines: these are the glyphs
geom_bspline2(data = atext_bd,
aes(x = rx,
y = ry,
color = type,
group = x,
linewidth = size),
n = 800,
lineend = "round") +
geom_bspline2(data = accents, 
aes(x = rx, 
y = ry, 
color = type, 
group = id,
linewidth = size * 3),
n = 800, 
lineend = "round") +
scale_linewidth_continuous(range = c(0, 1.5)) +
# Define colors for each typeglyphs
scale_color_manual(values = c("text" = "black", "signature" = "red")) +
theme_void() +
#coord_equal() +
theme(#aspect.ratio = 4,
legend.position = "none",
plot.background = element_rect(fill = "grey97", color = NA)
)

# Save named image
ggsave(glue::glue("outputs/asemic-haiku-bd-{seed}.png"),
height = 7,
width = 4,
units = "in")
```



